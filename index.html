<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ヒアリングシート</title>

  <style>
    :root {
      --bg: #f2f2f2;
      --line: #e6e6e6;
      --text: #222;
      --muted: #777;
      --card: #fff;
      --input: #fff;
      --radius: 6px;
      --dark: #222;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }

    .titlebar {
      background: #efefef;
      border-bottom: 1px solid var(--line);
      padding: 12px 14px;
      text-align: center;
      font-weight: 800;
      letter-spacing: .02em;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sheet {
      max-width: 720px;
      margin: 0 auto;
      background: var(--card);
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
    }

    .row {
      display: flex;
      gap: 12px;
      padding: 14px;
      border-top: 1px solid var(--line);
      align-items: flex-start;
    }
    .row:first-child { border-top: 0; }

    .label {
      width: 180px;
      min-width: 180px;
      font-weight: 800;
      padding-top: 10px;
      line-height: 1.2;
    }
    .label .req { margin-left: 4px; font-weight: 900; }

    .control { flex: 1; }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      line-height: 1.4;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid #d6d6d6;
      border-radius: var(--radius);
      padding: 0 12px;
      background: var(--input);
      font-size: 16px;
      outline: none;
    }

    input, select { height: 46px; }
    textarea {
      padding: 10px 12px;
      min-height: 110px;
      resize: vertical;
      font-size: 16px;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #9bbcff;
      box-shadow: 0 0 0 3px rgba(11, 99, 255, .12);
    }

    .subControl { margin-top: 10px; }

    /* アレルギー選択肢：縦並び */
    .chkGrid{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .chk{
      width: 100%;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border: 1px solid #d6d6d6;
      border-radius: 12px;
      background: #fff;
      font-weight: 800;
      user-select: none;
    }

    .chk input{
      width: 20px;
      height: 20px;
      accent-color: #111;
    }

    /* ===== 同意/ポップアップ ===== */
    .agreeBlock{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:2px;
    }

    .agreeLine{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      color:#222;
      user-select:none;
    }

    .agreeLine input{
      width:20px;
      height:20px;
      accent-color:#111;
    }

    .pillGreen{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:44px;
      padding:0 16px;
      border-radius:999px;
      border:2px solid #111;
      background:#fff;
      color:#111;
      font-weight:900;
      cursor:pointer;
      width:100%;
    }
    .pillGreen:hover{ background:#f4f4f4; }

    /* modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:100;
    }

    .modal{
      width:min(680px,100%);
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      max-height:85vh;
      display:flex;
      flex-direction:column;
    }

    .modalHeader{
      padding:14px 16px;
      font-weight:900;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .modalClose{
      border:0;
      background:#f2f2f2;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    .modalBody{
      padding:14px 16px;
      overflow:auto;
      line-height:1.75;
      font-size:14px;
      color:#222;
    }

    .legalText{
      white-space:pre-wrap;
      word-break:break-word;
    }

    .modalFooter{
      padding:12px 16px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
    }

    .agreeBtn{
      flex:1;
      height:46px;
      border:0;
      border-radius:12px;
      background:#111;
      color:#fff;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
    }

    .agreeBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .actionsRow {
      padding: 18px 14px 22px;
      border-top: 1px solid var(--line);
      background: #fff;
      position: sticky;
      bottom: 0;
      z-index: 5;
      padding-bottom: calc(22px + env(safe-area-inset-bottom));
    }

    .twoBtns { display: flex; gap: 12px; }

    .pillBack, .pillConfirm {
      flex: 1;
      height: 52px;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
    }

    .pillBack {
      border: 2px solid #666;
      background: #fff;
      color: #111;
    }

    .pillConfirm {
      border: 2px solid #111;
      background: #fff;
      color: #111;
    }

    .pillConfirm:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* confirm view */
    .confirm { display: none; padding: 14px; }
    .confirm h2 { margin: 8px 0 12px; font-size: 18px; }

    .summary {
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }

    .sumRow {
      display: flex;
      gap: 12px;
      padding: 12px 14px;
      border-top: 1px solid var(--line);
    }
    .sumRow:first-child { border-top: 0; }

    .sumKey {
      width: 200px;
      min-width: 200px;
      color: #111;
      font-weight: 900;
    }

    .sumVal { flex: 1; color: #222; word-break: break-word; }

    .confirmActions { display: flex; gap: 12px; margin-top: 14px; }

    .ghost {
      flex: 1;
      height: 52px;
      border-radius: 999px;
      border: 2px solid #666;
      background: #fff;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      color: #111;
    }

    .send {
      flex: 1;
      height: 52px;
      border-radius: 999px;
      border: 0;
      background: var(--dark);
      color: #fff;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
    }

    @media (max-width:520px) {
      .label { width: 140px; min-width: 140px; }
      .sumKey { width: 140px; min-width: 140px; }
    }

    /* ===== スマホ最適化 ===== */
    html { -webkit-text-size-adjust: 100%; }

    .sheet { max-width: 640px; width: 100%; }

    .row {
      display: grid;
      grid-template-columns: 140px 1fr;
      align-items: center;
      gap: 10px;
    }

    .label { width: auto; min-width: 0; padding-top: 0; font-size: 15px; }

    @media (max-width: 380px) {
      .row { grid-template-columns: 1fr; align-items: start; }
      .label { padding-top: 0; }
    }
  </style>
</head>

<body>
  <div class="titlebar">ヒアリングシート</div>

  <!-- 入力画面 -->
  <main class="sheet" id="inputView">
    <form id="karteForm" novalidate>

      <div class="row">
        <div class="label">① 通う頻度<span class="req">*</span></div>
        <div class="control">
          <p class="hint">どのくらいネイルサロンに通っていますか？</p>
          <select id="visitFreq" required>
            <option value="">—</option>
            <option value="初めて">初めて</option>
            <option value="数回">数回</option>
            <option value="1年以上">1年以上</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="label">② 1週間以内に浮き<span class="req">*</span></div>
        <div class="control">
          <p class="hint">今まで施術後、1週間以内に浮いた／取れたことがありますか？</p>
          <select id="liftWithinWeek" required>
            <option value="">—</option>
            <option value="ある">ある</option>
            <option value="ない">ない</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="label">③ 合わないベース<span class="req">*</span></div>
        <div class="control">
          <p class="hint">今まで合わなかったベースジェルはありますか？</p>
          <select id="badBase" required>
            <option value="">—</option>
            <option value="無し">無し</option>
            <option value="あり">あり</option>
          </select>

          <div class="subControl" id="badBaseDetailWrap" style="display:none;">
            <p class="hint">「あり」の場合、該当を選択してください。</p>
            <select id="badBaseKind">
              <option value="">—</option>
              <option value="パラジェル">パラジェル</option>
              <option value="その他">その他</option>
            </select>

            <div class="subControl" id="badBaseOtherWrap" style="display:none;">
              <p class="hint">「その他」の場合、内容をご記入ください。</p>
              <input id="badBaseOther" type="text" placeholder="例：メーカー名、症状など" />
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">④ 厚み出し<span class="req">*</span></div>
        <div class="control">
          <p class="hint">厚み出しご希望の方：+1000円</p>
          <select id="thickOption" required>
            <option value="">—</option>
            <option value="相談したい">相談したい</option>
            <option value="希望する">希望する</option>
            <option value="しない">しない</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="label">アレルギー<span class="req">*</span></div>
        <div class="control">
          <select id="allergy" required>
            <option value="">—</option>
            <option value="なし">なし</option>
            <option value="あり">あり</option>
          </select>

          <!-- 「あり」選択時に表示 -->
          <div class="subControl" id="allergyDetailWrap" style="display:none;">
            <p class="hint">「あり」の場合、該当するものを選択してください（複数可）。</p>

            <div class="chkGrid">
              <label class="chk">
                <input type="checkbox" id="allergyGel" value="ジェル" />
                ジェル
              </label>

              <label class="chk">
                <input type="checkbox" id="allergyFood" value="食品" />
                食品
              </label>

              <label class="chk">
                <input type="checkbox" id="allergyMetal" value="金属" />
                金属
              </label>

              <label class="chk">
                <input type="checkbox" id="allergyUV" value="紫外線" />
                紫外線
              </label>

              <label class="chk">
                <input type="checkbox" id="allergyDisinfectAlcohol" value="消毒用アルコール" />
                消毒用アルコール
              </label>

              <label class="chk">
                <input type="checkbox" id="allergyOther" value="その他" />
                その他
              </label>
            </div>

            <!-- 「その他」チェック時に表示（下に出す） -->
            <div class="subControl" id="allergyOtherWrap" style="display:none;">
              <p class="hint">「その他」の場合、内容をご記入ください。</p>
              <input id="allergyOtherText" type="text" placeholder="例：ラテックス、香料 など" />
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">ご要望など</div>
        <div class="control">
          <p class="hint">ご要望等ございましたらご記入ください。</p>
          <textarea id="memo" placeholder="例：爪が薄い／折れやすい、生活スタイル、希望デザインなど"></textarea>
        </div>
      </div>

      <!-- 承諾書および同意書 -->
      <div class="row">
        <div class="label">承諾書・同意書<span class="req">*</span></div>
        <div class="control">
          <div class="agreeBlock">
            <label class="agreeLine">
              <input id="agreeConsent" type="checkbox" disabled />
              <span>承諾書および同意書に同意する</span>
            </label>
            <button class="pillGreen" type="button" id="openConsent">内容を確認する</button>
          </div>
        </div>
      </div>

      <!-- 個人情報の取り扱いについて -->
      <div class="row">
        <div class="label">個人情報<span class="req">*</span></div>
        <div class="control">
          <div class="agreeBlock">
            <label class="agreeLine">
              <input id="agreePrivacy" type="checkbox" disabled />
              <span>個人情報の取り扱いに同意する</span>
            </label>
            <small class="hint">※ポップアップ内を下までスクロールすると「同意する」が押せます。</small>
            <button class="pillGreen" type="button" id="openPrivacy">内容を確認する</button>
          </div>
        </div>
      </div>

      <div class="actionsRow">
        <div class="twoBtns">
          <button class="pillBack" type="button" id="backFromInput">戻る</button>
          <!-- ✅ 同意が揃うまで無効 -->
          <button class="pillConfirm" type="button" id="toConfirm" disabled>確認</button>
        </div>
      </div>
    </form>
  </main>

  <!-- 確認画面 -->
  <main class="sheet confirm" id="confirmView" aria-live="polite">
    <div style="padding:14px;">
      <h2>入力内容の確認</h2>
      <div class="summary" id="summary"></div>

      <div class="confirmActions">
        <button class="ghost" type="button" id="backBtn">戻る</button>
        <button class="send" type="button" id="sendBtn">送信</button>
      </div>
    </div>
  </main>

  <!-- 承諾書・同意書 モーダル -->
  <div class="modalOverlay" id="consentModal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="modal">
      <div class="modalHeader">
        <div id="consentTitle">承諾書および同意書</div>
        <button class="modalClose" type="button" data-close="consentModal">閉じる</button>
      </div>
      <div class="modalBody" id="consentBody">
        <div class="legalText">承諾書および同意書
・施術中に痛みやかゆみが生じた場合はすぐに申し出てください。
・皮膚疾患がみられる場合、施術できない場合があります。
・ご自身で無理やり除去されますと、自爪を痛める原因となります。
・お爪の状態によってはお直しできない場合もございます。
・施術後、浮いてきたり、裂が入ったまま放置されますと、爪の疾患につながる恐れがありますので、お直しにご来店ください。判断が難しい場合は一度ご相談ください。</div>
      </div>
      <div class="modalFooter">
        <button class="agreeBtn" type="button" id="agreeConsentBtn" disabled>同意する</button>
      </div>
    </div>
  </div>

  <!-- 個人情報 モーダル -->
  <div class="modalOverlay" id="privacyModal" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
    <div class="modal">
      <div class="modalHeader">
        <div id="privacyTitle">個人情報の取り扱いについて</div>
        <button class="modalClose" type="button" data-close="privacyModal">閉じる</button>
      </div>
      <div class="modalBody" id="privacyBody">
        <div class="legalText">個人情報の取り扱いについて
・当サロンは、ご提供いただいた個人情報を第三者へ開示することはいたしません。
・お問い合わせ、ご相談等への対応や、キャンペーンに関するご連絡等で利用いたします。
・あらかじめ、同意または承諾いただいている場合や、法令等に基づく場合はこの限りではありません。</div>
      </div>
      <div class="modalFooter">
        <button class="agreeBtn" type="button" id="agreePrivacyBtn" disabled>同意する</button>
      </div>
    </div>
  </div>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <script>
    const LIFF_ID = "2008747284-rcXJk7GI";

    const el = (id) => document.getElementById(id);

    const inputView = el("inputView");
    const confirmView = el("confirmView");
    const summaryEl = el("summary");

    const visitFreq = el("visitFreq");
    const liftWithinWeek = el("liftWithinWeek");
    const badBase = el("badBase");
    const badBaseDetailWrap = el("badBaseDetailWrap");
    const badBaseKind = el("badBaseKind");
    const badBaseOtherWrap = el("badBaseOtherWrap");
    const badBaseOther = el("badBaseOther");

    const thickOption = el("thickOption");

    const allergy = el("allergy");
    const allergyDetailWrap = el("allergyDetailWrap");

    const allergyGel = el("allergyGel");
    const allergyFood = el("allergyFood");
    const allergyMetal = el("allergyMetal");
    const allergyUV = el("allergyUV");
    const allergyDisinfectAlcohol = el("allergyDisinfectAlcohol");

    const allergyOther = el("allergyOther");
    const allergyOtherWrap = el("allergyOtherWrap");
    const allergyOtherText = el("allergyOtherText");

    const memo = el("memo");

    const toConfirm = el("toConfirm");
    const backFromInput = el("backFromInput");
    const backBtn = el("backBtn");
    const sendBtn = el("sendBtn");

    // 同意（チェック）
    const agreeConsent = el("agreeConsent");
    const agreePrivacy = el("agreePrivacy");

    // 開くボタン
    const openConsent = el("openConsent");
    const openPrivacy = el("openPrivacy");

    // モーダル
    const consentModal = el("consentModal");
    const privacyModal = el("privacyModal");

    // スクロール領域
    const consentBody = el("consentBody");
    const privacyBody = el("privacyBody");

    // モーダル内の同意ボタン
    const agreeConsentBtn = el("agreeConsentBtn");
    const agreePrivacyBtn = el("agreePrivacyBtn");

    document.addEventListener("DOMContentLoaded", async () => {
      try { await liff.init({ liffId: LIFF_ID }); }
      catch (e) { console.warn("LIFF init failed (ブラウザ確認中はOK):", e); }

      syncConditionalUI();
      refreshConfirmButton();
    });

    function refreshConfirmButton() {
      toConfirm.disabled = !(agreeConsent.checked && agreePrivacy.checked);
    }

    function syncConditionalUI() {
      // ③ 合わないベース
      const isBadBase = badBase.value === "あり";
      badBaseDetailWrap.style.display = isBadBase ? "block" : "none";
      if (!isBadBase) {
        badBaseKind.value = "";
        badBaseOther.value = "";
        badBaseOtherWrap.style.display = "none";
      }

      const isOther = badBaseKind.value === "その他";
      badBaseOtherWrap.style.display = isBadBase && isOther ? "block" : "none";
      if (!(isBadBase && isOther)) badBaseOther.value = "";

      // アレルギー
      const isAllergy = allergy.value === "あり";
      allergyDetailWrap.style.display = isAllergy ? "block" : "none";

      const allergyChecks = [
        allergyGel,
        allergyFood,
        allergyMetal,
        allergyUV,
        allergyDisinfectAlcohol,
        allergyOther
      ];

      if (!isAllergy) {
        allergyChecks.forEach(chk => chk.checked = false);
        allergyOtherText.value = "";
        allergyOtherWrap.style.display = "none";
      } else {
        allergyOtherWrap.style.display = allergyOther.checked ? "block" : "none";
        if (!allergyOther.checked) allergyOtherText.value = "";
      }
    }

    badBase.addEventListener("change", syncConditionalUI);
    badBaseKind.addEventListener("change", syncConditionalUI);
    allergy.addEventListener("change", syncConditionalUI);

    [
      allergyGel,
      allergyFood,
      allergyMetal,
      allergyUV,
      allergyDisinfectAlcohol,
      allergyOther
    ].forEach(chk => chk.addEventListener("change", syncConditionalUI));

    backFromInput.addEventListener("click", () => {
      try {
        if (window.liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
        else history.back();
      } catch (e) { history.back(); }
    });

    // ===== モーダル共通：下までスクロールしたら同意ボタン有効 =====
    function openModalWithScrollGate(modalEl, bodyEl, agreeBtnEl) {
      modalEl.style.display = "flex";
      agreeBtnEl.disabled = true;
      bodyEl.scrollTop = 0;

      const check = () => {
        const nearBottom = bodyEl.scrollTop + bodyEl.clientHeight >= bodyEl.scrollHeight - 4;
        if (nearBottom) agreeBtnEl.disabled = false;
      };

      check();
      bodyEl._scrollGateHandler && bodyEl.removeEventListener("scroll", bodyEl._scrollGateHandler);
      bodyEl._scrollGateHandler = check;
      bodyEl.addEventListener("scroll", check, { passive: true });
    }

    openConsent.addEventListener("click", () => openModalWithScrollGate(consentModal, consentBody, agreeConsentBtn));
    openPrivacy.addEventListener("click", () => openModalWithScrollGate(privacyModal, privacyBody, agreePrivacyBtn));

    // 閉じる（ボタン＆背景）
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => el(btn.dataset.close).style.display = "none");
    });
    [consentModal, privacyModal].forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });
    });

    // 同意する → チェックON
    agreeConsentBtn.addEventListener("click", () => {
      agreeConsent.checked = true;
      consentModal.style.display = "none";
      refreshConfirmButton();
    });
    agreePrivacyBtn.addEventListener("click", () => {
      agreePrivacy.checked = true;
      privacyModal.style.display = "none";
      refreshConfirmButton();
    });

    function getFormData() {
      const selectedAllergies = [];
      if (allergyGel.checked) selectedAllergies.push("ジェル");
      if (allergyFood.checked) selectedAllergies.push("食品");
      if (allergyMetal.checked) selectedAllergies.push("金属");
      if (allergyUV.checked) selectedAllergies.push("紫外線");
      if (allergyDisinfectAlcohol.checked) selectedAllergies.push("消毒用アルコール");

      if (allergyOther.checked) {
        const t = allergyOtherText.value.trim();
        selectedAllergies.push(t ? `その他：${t}` : "その他");
      }

      const d = {
        visitFreq: visitFreq.value,
        liftWithinWeek: liftWithinWeek.value,
        badBase: badBase.value,
        badBaseKind: badBaseKind.value || "—",
        badBaseOther: badBaseOther.value.trim() || "—",
        thickOption: thickOption.value,
        allergy: allergy.value,
        memo: memo.value.trim() || "—",
      };

      // 表示用に整形（③）
      if (d.badBase !== "あり") {
        d.badBaseDetailText = "無し";
      } else {
        if (d.badBaseKind === "パラジェル") d.badBaseDetailText = "あり（パラジェル）";
        else if (d.badBaseKind === "その他") d.badBaseDetailText = `あり（その他：${d.badBaseOther}）`;
        else d.badBaseDetailText = "あり（未選択）";
      }

      // 表示用に整形（アレルギー）
      if (d.allergy !== "あり") {
        d.allergyText = "なし";
      } else {
        d.allergyText = selectedAllergies.length
          ? `あり（${selectedAllergies.join("、")}）`
          : "あり（未選択）";
      }

      // バリデーション用
      d.selectedAllergies = selectedAllergies;

      return d;
    }

    function validate() {
      const d = getFormData();

      if (!d.visitFreq) { alert("① 通う頻度を選択してください。"); visitFreq.focus(); return null; }
      if (!d.liftWithinWeek) { alert("② 1週間以内に浮いたことがあるかを選択してください。"); liftWithinWeek.focus(); return null; }

      if (!d.badBase) { alert("③ 合わないベースの有無を選択してください。"); badBase.focus(); return null; }
      if (d.badBase === "あり") {
        if (!badBaseKind.value) { alert("③「あり」の場合、パラジェル／その他を選択してください。"); badBaseKind.focus(); return null; }
        if (badBaseKind.value === "その他" && !badBaseOther.value.trim()) {
          alert("③「その他」の内容をご記入ください。"); badBaseOther.focus(); return null;
        }
      }

      if (!d.thickOption) { alert("④ 厚み出し（+1000円）の希望を選択してください。"); thickOption.focus(); return null; }

      if (!d.allergy) { alert("アレルギーの有無を選択してください。"); allergy.focus(); return null; }
      if (d.allergy === "あり") {
        if (!d.selectedAllergies.length) {
          alert("アレルギー「あり」の場合、該当する項目を選択してください。");
          return null;
        }
        if (allergyOther.checked && !allergyOtherText.value.trim()) {
          alert("アレルギー「その他」の内容をご記入ください。");
          allergyOtherText.focus();
          return null;
        }
      }

      // ✅ 同意チェック
      if (!agreeConsent.checked) { alert("承諾書および同意書を確認し、同意してください。"); return null; }
      if (!agreePrivacy.checked) { alert("個人情報の取り扱いを確認し、同意してください。"); return null; }

      return d;
    }

    // confirm step
    toConfirm.addEventListener("click", () => {
      const d = validate();
      if (!d) return;

      const rows = [
        ["① 通う頻度", d.visitFreq],
        ["② 1週間以内に浮き", d.liftWithinWeek],
        ["③ 合わないベース", d.badBaseDetailText],
        ["④ 厚み出し（+1000円）", d.thickOption],
        ["アレルギー", d.allergyText],
        ["ご要望など", d.memo],
        ["承諾書・同意書", "同意済み"],
        ["個人情報", "同意済み"],
      ];

      summaryEl.innerHTML = rows.map(([k, v]) => `
        <div class="sumRow">
          <div class="sumKey">${escapeHtml(k)}</div>
          <div class="sumVal">${escapeHtml(v)}</div>
        </div>
      `).join("");

      inputView.style.display = "none";
      confirmView.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    backBtn.addEventListener("click", () => {
      confirmView.style.display = "none";
      inputView.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // send
    sendBtn.addEventListener("click", async () => {
      const d = validate();
      if (!d) return;

      const text =
`≪ヒアリングシート≫
【① 通う頻度】${d.visitFreq}
【② 1週間以内に浮き】${d.liftWithinWeek}
【③ 合わないベース】${d.badBaseDetailText}
【④ 厚み出し（+1000円）】${d.thickOption}
【アレルギー】${d.allergyText}
【ご要望など】${d.memo}
【承諾書・同意書】同意済み
【個人情報】同意済み`;

      try {
        if (window.liff && liff.isInClient && liff.isInClient()) {
          await liff.sendMessages([{ type: "text", text }]);
          alert("ご記入ありがとうございます。");
          liff.closeWindow();
        } else {
          alert("（ブラウザ確認）送信テキストをコンソールに出力しました。");
          console.log(text);
        }
      } catch (e) {
        console.error(e);
        alert("送信に失敗しました。もう一度お試しください。");
      }
    });

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>

</html>
